#!/usr/bin/env bash

function check() {
  SOURCE=$1
  CSP_API_TOKEN=$(echo "${SOURCE}" | jq -r .source.csp_api_token)
  if [ -z "${CSP_API_TOKEN}" ]; then
    echo "Missing CSP API Token. Please ensure that source.csp_api_token has been set." >&2
    return 1
  fi

  MARKETPLACE_ENV=$(echo "${SOURCE}" | jq -r .source.marketplace_env)
  PRODUCT_SLUG=$(echo "${SOURCE}" | jq -r .source.product_slug)
  if [ -z "${PRODUCT_SLUG}" ]; then
    echo "Missing Marketplace product slug. Please ensure that source.product_slug has been set." >&2
    return 1
  fi
  export CSP_API_TOKEN MARKETPLACE_ENV

  set -e
  versions=$(mkpcli product list-versions --product "${PRODUCT_SLUG}" --output json)
  echo "${versions}" | jq \
  '[
    .[] | with_entries(select([.key] | inside(["versionnumber"])))
  ] | reverse'
}

if [ "$0" = "${BASH_SOURCE[0]}" ]; then
  SOURCE=$(cat)
  main "$SOURCE"
fi
