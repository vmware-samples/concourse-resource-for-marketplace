#!/usr/bin/env bash

SOURCE=$(cat)
CSP_API_TOKEN=$(jq -r .source.csp_api_token <(echo "${SOURCE}"))
MARKETPLACE_ENV=$(jq -r .source.marketplace_env <(echo "${SOURCE}"))
PRODUCT_SLUG=$(jq -r .source.product_slug <(echo "${SOURCE}"))
export CSP_API_TOKEN MARKETPLACE_ENV

#VERSION=$(jq -r .version <(echo "${SOURCE}"))

versions=$(mkpcli product list-versions --product "${PRODUCT_SLUG}" --output json)
jq '[
     .[] | with_entries(select([.key] | inside(["versionnumber"])))
   ] | reverse[]' <(echo "${versions}")
